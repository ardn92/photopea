<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Amirs Plugin â€” All Processes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #f7f7fa;
      min-width: 250px;
      max-width: 380px;
    }
    .panel {
      width: 100%;
      max-width: 340px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 16px #0001;
      padding: 18px 14px 12px 14px;
      margin-bottom: 16px;
    }
    h2 {
      font-weight: 600;
      margin: 8px 0 12px 0;
      color: #3b3c45;
      font-size: 22px;
      text-align: center;
      letter-spacing: 1px;
    }
    h3 {
      font-size: 17px;
      margin: 8px 0 10px 0;
      font-weight: 500;
      color: #586674;
      letter-spacing: 0.3px;
    }
    .row {
      width: 100%;
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      margin-bottom: 8px;
    }
    .col {
      flex: 1 1 0;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }
    .btn {
      padding: 7px 18px;
      margin: 4px;
      font-size: 15px;
      border: none;
      border-radius: 7px;
      background: linear-gradient(90deg, #5a8dee 40%, #37c9c6 100%);
      color: #fff;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s;
      box-shadow: 0 2px 8px #0072cf13;
    }
    .btn:disabled {
      background: #ccd3e0;
      color: #9ca3b1;
      cursor: not-allowed;
      box-shadow: none;
    }
    #imgArea {
      max-width: 270px;
      max-height: 270px;
      border-radius: 11px;
      box-shadow: 0 2px 10px #0088ff13;
      background: #eaf2fb;
      object-fit: contain;
      border: 1.5px solid #e2e6ed;
      margin: 0 auto 0 auto;
      display: block;
    }
    #statusText {
      margin-top: 10px;
      color: #21a17a;
      font-weight: 600;
      text-align: center;
      font-size: 15px;
    }
    #statusText.error {
      color: #d10022;
    }
    @media (max-width: 480px) {
      .panel { padding: 9px 4px 7px 4px; }
      h2 { font-size: 17px; }
      #imgArea { max-width: 180px; max-height: 180px; }
    }
  </style>
</head>
<body>
  <h2>Amirs Plugin</h2>

  <!-- Row 1: Image Display -->
  <div class="panel" style="margin-bottom:8px;">
    <img id="imgArea" alt="Loaded Image" src="" />
    <div id="statusText"></div>
  </div>

  <!-- Row 2: Load Image -->
  <div class="panel row" style="justify-content:center;">
    <button class="btn" id="loadBtn">Load Image</button>
  </div>

  <!-- Row 3: Script Processes -->
  <div class="panel">
    <h3>Script processes</h3>
    <div class="row">
      <button class="btn" id="gridBtn" disabled>Create Grid</button>
    </div>
  </div>

  <!-- Row 4: External Processes -->
  <div class="panel">
    <h3>External processes</h3>
    <div class="row" style="flex-wrap:wrap;gap:10px;">
      <button class="btn" id="downsizeBtn" disabled>Downsize</button>
      <button class="btn" id="enlargeBtn" disabled>Enlarge</button>
      <button class="btn" id="grayBtn" disabled>Grayscale</button>
      <button class="btn" id="cropBtn" disabled>Crop Center</button>
    </div>
  </div>

  <script>
    let imageBuffer = null;
    let expectingImage = null;
    const statusText = document.getElementById("statusText");

    // Utility: Enable or disable all processing buttons
    function setProcessingButtons(enabled) {
      document.getElementById("gridBtn").disabled = !enabled;
      document.getElementById("downsizeBtn").disabled = !enabled;
      document.getElementById("enlargeBtn").disabled = !enabled;
      document.getElementById("grayBtn").disabled = !enabled;
      document.getElementById("cropBtn").disabled = !enabled;
    }

    window.addEventListener("message", (e) => {
      if (e.data === "done") {
        if (expectingImage === "load" || expectingImage === "post") {
          window.parent.postMessage('app.activeDocument.saveToOE("png");', "*");
        }
      } else if (e.data instanceof ArrayBuffer) {
        imageBuffer = e.data;
        const blob = new Blob([imageBuffer], { type: "image/png" });
        document.getElementById("imgArea").src = URL.createObjectURL(blob);
        setProcessingButtons(true);
        statusText.textContent = "";
      }
    });

    document.getElementById("loadBtn").onclick = () => {
      expectingImage = "load";
      window.parent.postMessage('app.activeDocument.saveToOE("png");', "*");
    };

    document.getElementById("gridBtn").onclick = () => {
      if (!imageBuffer) return;
      const script = `
        var doc = app.activeDocument;
        var layer = doc.activeLayer;
        var count = 5, gap = 10;
        var w = layer.bounds[2] - layer.bounds[0];
        var scaledW = w * 0.2;
        for (var i = 0; i < count; i++) {
          var dup = layer.duplicate();
          dup.resize(20, 20, AnchorPosition.TOPLEFT);
          dup.translate(i * (scaledW + gap), 0);
        }
      `;
      expectingImage = "post";
      window.parent.postMessage(script, "*");
      window.parent.postMessage('app.activeDocument.saveToOE("png");', "*");
    };

    // Handles external processing
    async function processExternal(endpoint) {
      if (!imageBuffer) return;
      statusText.textContent = "Processing...";
      statusText.classList.remove("error");
      statusText.style.display = "block";
      setProcessingButtons(false);

      try {
        const blob = new Blob([imageBuffer], { type: "image/png" });
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'image/png' },
          body: blob
        });
        if (!response.ok) throw new Error(`Server responded with ${response.status}`);
        const processedBlob = await response.blob();
        const newUrl = URL.createObjectURL(processedBlob);

        // Update preview in plugin
        const imgElem = document.getElementById("imgArea");
        imgElem.src = newUrl;
        imgElem.style.display = "block";

        // Update main Photopea panel with new image
        const reader = new FileReader();
        reader.onloadend = function() {
          const base64data = reader.result;
          window.parent.postMessage(
            `app.open("${base64data}");`,
            "*"
          );
        };
        reader.readAsDataURL(processedBlob);

        statusText.textContent = "Process is done";
        setTimeout(() => {
          statusText.textContent = "";
          statusText.style.display = "none";
        }, 1500);
        setProcessingButtons(true);
      } catch (err) {
        console.error("External processing failed:", err);
        statusText.textContent = "Process failed: " + err.message;
        statusText.classList.add("error");
        setTimeout(() => {
          statusText.textContent = "";
          statusText.style.display = "none";
        }, 4000);
        setProcessingButtons(true);
      }
    }

    document.getElementById("downsizeBtn").onclick = () => processExternal('/api/resize');
    document.getElementById("enlargeBtn").onclick = () => processExternal('/api/enlarge');
    document.getElementById("grayBtn").onclick = () => processExternal('/api/grayscale');
    document.getElementById("cropBtn").onclick = () => processExternal('/api/crop_center');
  </script>
</body>
</html>
